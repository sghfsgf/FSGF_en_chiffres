<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicon-512x512.png">

<!-- Manifest pour PWA -->
<link rel="manifest" href="/manifest.json">
  <title>FSGF en chiffres - Statistiques</title>
  <link rel="stylesheet" href="/CSS/style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

<header class="topbar">
  <div class="logo">FSGF en chiffres</div>
  <nav class="menu">
    <a href="index.html">Accueil</a>
    <a href="statistiques.html">Statistiques</a>
    <a href="comparaisons.html">Comparaisons</a>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<main>
  <h1>Statistiques des étudiants</h1>

  <!-- Section Sélection -->
  <section id="selection">
    <h2>Sélection</h2>

    <label for="yearSelect">Année :</label>
    <select id="yearSelect"></select>

    <label for="deptSelect">Département :</label>
    <select id="deptSelect"></select>

    <label for="niveauSelect">Niveau :</label>
    <select id="niveauSelect"></select>

    <label for="genreSelect">Genre :</label>
    <select id="genreSelect"></select>

    <button id="applySelection">Afficher</button>
  </section>

  <!-- Section Affichage des Résultats -->
  <section id="resultats" class="card">
    <h2>Affichage des Résultats</h2>
    <div id="tableContainer">
      <p>Aucun résultat à afficher</p>
    </div>
    <button id="exportExcel">Exporter en Excel</button>
  </section>
</main>

<footer>
  © 2026 FSGF en chiffres
</footer>

<script>
let statsData = [];

// Charger le fichier Excel
fetch('data/fsgf.xlsx')
  .then(res => res.arrayBuffer())
  .then(data => {
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets["Donnees"];
    if (!sheet) return console.log("Feuille Donnees introuvable");
    statsData = XLSX.utils.sheet_to_json(sheet);
    initSelections();
  })
  .catch(() => console.log("Aucun fichier Excel trouvé (normal au début)"));

// Initialiser les listes déroulantes avec "Tous"
function initSelections() {
  const years = [...new Set(statsData.map(d => d.Année))].sort((a,b) => b-a);
  const depts = [...new Set(statsData.map(d => d.Département))];
  const niveaux = [...new Set(statsData.map(d => d.Niveau))];
  const genres = [...new Set(statsData.map(d => d.Genre))];

  const yearSelect = document.getElementById("yearSelect");
  yearSelect.innerHTML = `<option value="">Tous</option>`;
  years.forEach(y => yearSelect.innerHTML += `<option value="${y}">${y}</option>`);

  const deptSelect = document.getElementById("deptSelect");
  deptSelect.innerHTML = `<option value="">Tous</option>`;
  depts.forEach(d => deptSelect.innerHTML += `<option value="${d}">${d}</option>`);

  const niveauSelect = document.getElementById("niveauSelect");
  niveauSelect.innerHTML = `<option value="">Tous</option>`;
  niveaux.forEach(n => niveauSelect.innerHTML += `<option value="${n}">${n}</option>`);

  const genreSelect = document.getElementById("genreSelect");
  genreSelect.innerHTML = `<option value="">Tous</option>`;
  genres.forEach(g => genreSelect.innerHTML += `<option value="${g}">${g}</option>`);
}

// Mettre à jour le tableau selon la sélection
function updateTable() {
  const year = document.getElementById("yearSelect").value;
  const dept = document.getElementById("deptSelect").value;
  const niveau = document.getElementById("niveauSelect").value;
  const genre = document.getElementById("genreSelect").value;

  let filtered = statsData;

  if(year) filtered = filtered.filter(d => d.Année == year);
  if(dept) filtered = filtered.filter(d => d.Département == dept);
  if(niveau) filtered = filtered.filter(d => d.Niveau == niveau);
  if(genre) filtered = filtered.filter(d => d.Genre == genre);

  const tableContainer = document.getElementById("tableContainer");

  if(filtered.length === 0){
    tableContainer.innerHTML = "<p>Aucun résultat à afficher</p>";
    return;
  }

  let html = `<table>
    <thead>
      <tr>
        <th>Année</th>
        <th>Département</th>
        <th>Niveau</th>
        <th>Filière</th>
        <th>Genre</th>
        <th>Effectifs</th>
      </tr>
    </thead>
    <tbody>`;

  filtered.forEach(d => {
    html += `<tr>
      <td>${d.Année}</td>
      <td>${d.Département}</td>
      <td>${d.Niveau}</td>
      <td>${d.Filière}</td>
      <td>${d.Genre}</td>
      <td>${d.Effectifs}</td>
    </tr>`;
  });

  html += `</tbody></table>`;
  tableContainer.innerHTML = html;
}

// Bouton Afficher
document.getElementById("applySelection").addEventListener("click", updateTable);

// Export Excel
document.getElementById("exportExcel").addEventListener("click", function(){
  const table = document.querySelector("#tableContainer table");
  if(!table) return alert("Aucun résultat à exporter");

  const ws = XLSX.utils.table_to_sheet(table);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Résultats");
  XLSX.writeFile(wb, "FSGF_Statistiques.xlsx");
});
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/worker.js')
    .then(() => console.log('Service Worker enregistré'))
    .catch(err => console.log('Erreur SW:', err));
}
</script>
</body>
</html>
