<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>FSGF en chiffres - Statistiques</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

<header class="topbar">
  <div class="logo">FSGF en chiffres</div>
  <nav class="menu">
    <a href="index.html">Accueil</a>
    <a href="statistiques.html">Statistiques</a>
    <a href="comparaisons.html">Comparaisons</a>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<main>
  <h1>Statistiques des étudiants</h1>

  <!-- Section Filtres -->
  <section>
    <h2>Filtres</h2>
    <form id="filterForm">
      <label for="annee">Année :</label>
      <select id="annee"></select>

      <label for="departement">Département :</label>
      <select id="departement"></select>

      <label for="niveau">Niveau :</label>
      <select id="niveau"></select>

      <label for="genre">Genre :</label>
      <select id="genre">
        <option value="">Tous</option>
        <option value="M">Masculin</option>
        <option value="F">Féminin</option>
      </select>

      <button type="button" id="applyFilter">Afficher</button>
    </form>
  </section>

  <!-- Section Tableau -->
  <section>
    <h2>Résultats filtrés</h2>
    <table id="statsTable">
      <thead>
        <tr>
          <th>Année</th>
          <th>Département</th>
          <th>Niveau</th>
          <th>Filière</th>
          <th>Genre</th>
          <th>Effectifs</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="exportFiltered">Exporter le résultat</button>
  </section>
</main>

<footer>
  © 2026 FSGF en chiffres
</footer>

<script>
let statsData = [];

// Charger le fichier Excel
fetch('data/fsgf.xlsx')
  .then(res => res.arrayBuffer())
  .then(data => {
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets["Donnees"];
    statsData = XLSX.utils.sheet_to_json(sheet);
    populateFilters(statsData);
  });

// Remplir les filtres dynamiquement
function populateFilters(data) {
  const anneeSet = [...new Set(data.map(d => d.Année))];
  const deptSet = [...new Set(data.map(d => d.Département))];
  const niveauSet = [...new Set(data.map(d => d.Niveau))];

  document.getElementById("annee").innerHTML = '<option value="">Tous</option>' + anneeSet.map(a=>`<option value="${a}">${a}</option>`).join('');
  document.getElementById("departement").innerHTML = '<option value="">Tous</option>' + deptSet.map(d=>`<option value="${d}">${d}</option>`).join('');
  document.getElementById("niveau").innerHTML = '<option value="">Tous</option>' + niveauSet.map(n=>`<option value="${n}">${n}</option>`).join('');
}

// Appliquer les filtres et afficher le tableau
document.getElementById("applyFilter").addEventListener("click", ()=>{
  const annee = document.getElementById("annee").value;
  const dept = document.getElementById("departement").value;
  const niveau = document.getElementById("niveau").value;
  const genre = document.getElementById("genre").value;

  let filtered = statsData.filter(d=>{
    return (annee === "" || d.Année == annee) &&
           (dept === "" || d.Département == dept) &&
           (niveau === "" || d.Niveau == niveau) &&
           (genre === "" || d.Genre == genre);
  });

  displayStatsTable(filtered);
});

// Afficher le tableau filtré
function displayStatsTable(data){
  const tbody = document.querySelector("#statsTable tbody");
  tbody.innerHTML = "";
  data.forEach(d=>{
    tbody.innerHTML += `<tr>
      <td>${d.Année}</td>
      <td>${d.Département}</td>
      <td>${d.Niveau}</td>
      <td>${d.Filière}</td>
      <td>${d.Genre}</td>
      <td>${d.Effectifs}</td>
    </tr>`;
  });
}

// Exporter les résultats filtrés en Excel
document.getElementById("exportFiltered").addEventListener("click", ()=>{
  const tbody = document.querySelector("#statsTable tbody");
  if(tbody.rows.length === 0){ alert("Aucune donnée à exporter"); return; }

  const data = Array.from(tbody.rows).map(row => ({
    Année: row.cells[0].textContent,
    Département: row.cells[1].textContent,
    Niveau: row.cells[2].textContent,
    Filière: row.cells[3].textContent,
    Genre: row.cells[4].textContent,
    Effectifs: row.cells[5].textContent
  }));

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Filtré");
  XLSX.writeFile(wb, "fsgf_filtre.xlsx");
});
</script>

</body>
</html>
