<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicon-512x512.png">

<!-- Manifest pour PWA -->
<link rel="manifest" href="/manifest.json">
  <title>FSGF en chiffres - Admin</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

<header class="topbar">
  <div class="logo">FSGF en chiffres</div>
  <nav class="menu">
    <a href="index.html">Accueil</a>
    <a href="statistiques.html">Statistiques</a>
    <a href="comparaisons.html">Comparaisons</a>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<main>

  <!-- LOGIN -->
  <section class="card" id="loginBox">
    <h2>Accès Administration</h2>
    <label>Mot de passe</label>
    <input type="password" id="passwordInput">
    <button id="loginBtn">Entrer</button>
  </section>

  <!-- ADMIN -->
  <div id="adminPanel" style="display:none;">

    <h1>Administration des Statistiques</h1>

    <!-- FORMULAIRE AJOUT / MODIF -->
    <section class="card">
      <h2>Ajouter / Modifier un enregistrement</h2>

      <input type="hidden" id="editIndex">

      <label>Année</label>
      <input type="number" id="annee">

      <label>Département</label>
      <input type="text" id="departement">

      <label>Niveau</label>
      <select id="niveau">
        <option value="L1">L1</option>
        <option value="L2">L2</option>
        <option value="L3">L3</option>
        <option value="M1">M1</option>
        <option value="M2">M2</option>
      </select>

      <label>Filière</label>
      <input type="text" id="filiere">

      <label>Genre</label>
      <select id="genre">
        <option value="Masculin">Masculin</option>
        <option value="Féminin">Féminin</option>
      </select>

      <label>Effectifs</label>
      <input type="number" id="effectifs">

      <button id="saveBtn">Enregistrer</button>
      <button id="exportBtn">Télécharger Excel</button>
      <input type="file" id="importFile" accept=".xlsx">
      <button id="importBtn">Importer Excel</button>
    </section>

    <!-- TABLEAU EXISTANT -->
    <section class="card">
      <h2>Données existantes</h2>
      <div id="tableContainer"></div>
    </section>

  </div>
</main>

<footer>
  © 2026 FSGF en chiffres
</footer>

<script>
const ADMIN_PASSWORD = "FSGF&2026&";   // modifie si nécessaire
let data = [];

/* ===== LOGIN ===== */
document.getElementById("loginBtn").addEventListener("click", () => {
  const pwd = document.getElementById("passwordInput").value;
  if (pwd === ADMIN_PASSWORD) {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("adminPanel").style.display = "block";
    loadExcel();
  } else {
    alert("Mot de passe incorrect");
  }
});

/* ===== LECTURE EXCEL ===== */
function loadExcel() {
  fetch('data/fsgf.xlsx')
    .then(res => res.arrayBuffer())
    .then(buffer => {
      const workbook = XLSX.read(buffer, { type: "array" });
      const sheet = workbook.Sheets["Donnees"];
      if (!sheet) {
        alert("Feuille 'Donnees' introuvable");
        return;
      }
      data = XLSX.utils.sheet_to_json(sheet);
      refreshTable();
    })
    .catch(() => {
      console.log("Aucun fichier Excel trouvé (normal au début)");
    });
}

/* ===== TABLEAU ===== */
function refreshTable() {
  const container = document.getElementById("tableContainer");
  if (data.length === 0) {
    container.innerHTML = "<p>Aucune donnée disponible</p>";
    return;
  }
  let html = `<table>
    <thead>
      <tr>
        <th>Année</th>
        <th>Département</th>
        <th>Niveau</th>
        <th>Filière</th>
        <th>Genre</th>
        <th>Effectifs</th>
        <th>Actions</th>
      </tr>
    </thead><tbody>`;
  data.forEach((d, index) => {
    html += `<tr>
      <td>${d.Année}</td>
      <td>${d.Département}</td>
      <td>${d.Niveau}</td>
      <td>${d.Filière}</td>
      <td>${d.Genre}</td>
      <td>${d.Effectifs}</td>
      <td>
        <button onclick="editRow(${index})">Modifier</button>
        <button onclick="deleteRow(${index})">Supprimer</button>
      </td>
    </tr>`;
  });
  html += "</tbody></table>";
  container.innerHTML = html;
}

/* ===== AJOUT / MODIFICATION ===== */
document.getElementById("saveBtn").addEventListener("click", () => {
  const record = {
    Année: document.getElementById("annee").value,
    Département: document.getElementById("departement").value,
    Niveau: document.getElementById("niveau").value,
    Filière: document.getElementById("filiere").value,
    Genre: document.getElementById("genre").value,
    Effectifs: document.getElementById("effectifs").value
  };
  if (!record.Année || !record.Département || !record.Filière || !record.Effectifs) {
    alert("Veuillez remplir tous les champs");
    return;
  }
  const editIndex = document.getElementById("editIndex").value;
  if (editIndex === "") {
    data.push(record);
  } else {
    data[editIndex] = record;
    document.getElementById("editIndex").value = "";
  }
  clearForm();
  refreshTable();
});

/* ===== EDIT ===== */
function editRow(index) {
  const d = data[index];
  document.getElementById("annee").value = d.Année;
  document.getElementById("departement").value = d.Département;
  document.getElementById("niveau").value = d.Niveau;
  document.getElementById("filiere").value = d.Filière;
  document.getElementById("genre").value = d.Genre;
  document.getElementById("effectifs").value = d.Effectifs;
  document.getElementById("editIndex").value = index;
}

/* ===== DELETE ===== */
function deleteRow(index) {
  if (confirm("Supprimer cette ligne ?")) {
    data.splice(index, 1);
    refreshTable();
  }
}

/* ===== EXPORT EXCEL ===== */
document.getElementById("exportBtn").addEventListener("click", () => {
  if (data.length === 0) {
    alert("Aucune donnée à exporter");
    return;
  }
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Donnees");
  XLSX.writeFile(wb, "fsgf.xlsx");
});

/* ===== IMPORT EXCEL MULTI-LIGNES ===== */
document.getElementById("importBtn").addEventListener("click", () => {
  const fileInput = document.getElementById("importFile");
  const file = fileInput.files[0];
  if (!file) {
    alert("Veuillez sélectionner un fichier Excel à importer");
    return;
  }
  const reader = new FileReader();
  reader.onload = (e) => {
    const dataArray = new Uint8Array(e.target.result);
    const workbook = XLSX.read(dataArray, { type: "array" });
    const sheet = workbook.Sheets["Donnees"];
    if (!sheet) {
      alert("Feuille 'Donnees' introuvable dans le fichier");
      return;
    }
    const importedData = XLSX.utils.sheet_to_json(sheet);
    if (importedData.length === 0) {
      alert("Aucune donnée trouvée dans le fichier");
      return;
    }
    data = data.concat(importedData);
    refreshTable();
    alert(importedData.length + " lignes importées avec succès !");
  };
  reader.readAsArrayBuffer(file);
});

/* ===== UTILS ===== */
function clearForm() {
  document.getElementById("annee").value = "";
  document.getElementById("departement").value = "";
  document.getElementById("filiere").value = "";
  document.getElementById("effectifs").value = "";
}
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/worker.js')
    .then(() => console.log('Service Worker enregistré'))
    .catch(err => console.log('Erreur SW:', err));
}
</script>
</body>
</html>
