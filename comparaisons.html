<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>FSGF en chiffres - Comparaisons</title>

  <link rel="stylesheet" href="css/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Librairies -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<header class="topbar">
  <div class="logo">FSGF en chiffres</div>
  <nav class="menu">
    <a href="index.html">Accueil</a>
    <a href="statistiques.html">Statistiques</a>
    <a href="comparaisons.html">Comparaisons</a>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<main>
  <h1>Comparaisons</h1>

  <!-- Filtre AnnÃ©e -->
  <label for="yearFilter">SÃ©lectionner une annÃ©e :</label>
  <select id="yearFilter"></select>

  <!-- Graphiques existants -->
  <section style="display:flex; flex-wrap: wrap; gap:20px; margin-top:20px;">
    <div style="flex:1; min-width:300px;">
      <canvas id="deptChart"></canvas>
    </div>

    <div style="flex:1; min-width:300px;">
      <canvas id="niveauChart"></canvas>
    </div>

    <div style="flex:1; min-width:300px;">
      <canvas id="genreChart"></canvas>
    </div>
  </section>

  <!-- NOUVEAU GRAPHIQUE -->
  <h2 style="margin-top:40px;">Ã‰volution des effectifs totaux</h2>

  <div style="width:100%; max-width:900px; margin:auto;">
    <canvas id="totalYearChart"></canvas>

    <button id="exportPNG" style="margin-top:10px;">
      Exporter en PNG
    </button>
  </div>

</main>

<footer>
  Â© 2026 FSGF en chiffres
</footer>

<script>
let statsData = [];

// Charger Excel
fetch('data/fsgf.xlsx')
  .then(res => res.arrayBuffer())
  .then(data => {
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets["Donnees"];
    statsData = XLSX.utils.sheet_to_json(sheet);

    const years = [...new Set(statsData.map(d => d.AnnÃ©e))].sort((a,b) => b-a);
    const yearFilter = document.getElementById("yearFilter");

    years.forEach(y => yearFilter.innerHTML += `<option value="${y}">${y}</option>`);

    updateCharts(years[0]);
    buildYearChart();
  });

// Changement annÃ©e
document.getElementById("yearFilter").addEventListener("change", function() {
  updateCharts(this.value);
});

// Graphiques existants
function updateCharts(selectedYear){

  const currentYearData = statsData.filter(d => d.AnnÃ©e == selectedYear);

  // DÃ©partement
  const deptTotals = {};
  currentYearData.forEach(d => {
    if(!deptTotals[d.DÃ©partement]) deptTotals[d.DÃ©partement] = 0;
    deptTotals[d.DÃ©partement] += Number(d.Effectifs || 0);
  });

  const deptCtx = document.getElementById("deptChart").getContext("2d");
  if(window.deptChartObj) window.deptChartObj.destroy();

  window.deptChartObj = new Chart(deptCtx, {
    type: 'bar',
    data: {
      labels: Object.keys(deptTotals),
      datasets:[{
        label:'DÃ©partement',
        data:Object.values(deptTotals),
        backgroundColor:'#1f77b4'
      }]
    },
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });

  // Niveau
  const niveauTotals = {};
  currentYearData.forEach(d => {
    if(!niveauTotals[d.Niveau]) niveauTotals[d.Niveau] = 0;
    niveauTotals[d.Niveau] += Number(d.Effectifs || 0);
  });

  const niveauCtx = document.getElementById("niveauChart").getContext("2d");
  if(window.niveauChartObj) window.niveauChartObj.destroy();

  window.niveauChartObj = new Chart(niveauCtx,{
    type:'pie',
    data:{
      labels:Object.keys(niveauTotals),
      datasets:[{
        data:Object.values(niveauTotals)
      }]
    },
    options:{responsive:true}
  });

  // Genre
  const genreTotals = {M:0, F:0};
  currentYearData.forEach(d=>{
    if(d.Genre=="M") genreTotals.M += Number(d.Effectifs || 0);
    if(d.Genre=="F") genreTotals.F += Number(d.Effectifs || 0);
  });

  const genreCtx = document.getElementById("genreChart").getContext("2d");
  if(window.genreChartObj) window.genreChartObj.destroy();

  window.genreChartObj = new Chart(genreCtx,{
    type:'pie',
    data:{
      labels:["Masculin","FÃ©minin"],
      datasets:[{
        data:[genreTotals.M, genreTotals.F]
      }]
    },
    options:{responsive:true}
  });
}

// ðŸ”µ Courbe annuelle
function buildYearChart(){

  const totalsByYear = {};

  statsData.forEach(d => {
    if(!totalsByYear[d.AnnÃ©e]) totalsByYear[d.AnnÃ©e] = 0;
    totalsByYear[d.AnnÃ©e] += Number(d.Effectifs || 0);
  });

  const labels = Object.keys(totalsByYear).sort();
  const data = labels.map(y => totalsByYear[y]);

  const ctx = document.getElementById("totalYearChart").getContext("2d");

  window.totalYearChartObj = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Effectifs totaux',
        data: data,
        borderWidth: 2,
        fill: false,
        tension: 0.2
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

// ðŸ”µ Export PNG
document.getElementById("exportPNG").addEventListener("click", function(){
  const link = document.createElement('a');
  link.href = document.getElementById("totalYearChart").toDataURL("image/png");
  link.download = "effectifs_annuels.png";
  link.click();
});
</script>

</body>
</html>
