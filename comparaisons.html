<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FSGF en chiffres - Comparaisons</title>

  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="stylesheet" href="CSS/style.css">

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{ font-family: Arial, sans-serif; background:#f4f6f9; margin:0; color:#0f172a; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; padding:15px 20px; background:#ff6b00; color:white; }
    .menu a{ color:white; text-decoration:none; margin-left:15px; font-weight:500; }
    main{ padding:20px; }
    h1,h2{text-align:center;}
    canvas{ background:white; border-radius:12px; padding:10px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
    select, button{ padding:6px; border-radius:6px; border:1px solid #ddd; margin:4px; }
    button#exportPNG{ background:#ff7f0e; color:white; border:none; cursor:pointer; font-weight:bold; }
    button#exportPNG:hover{ background:#ff9500; }
    footer{ text-align:center; padding:10px; background:#000; color:white; margin-top:20px; }
  </style>
</head>

<body>

<header class="topbar">
  <div class="logo">FSGF en chiffres</div>
  <nav class="menu">
    <a href="index.html">Accueil</a>
    <a href="statistiques.html">Statistiques</a>
    <a href="comparaisons.html">Comparaisons</a>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<main>
  <h1>Comparaisons</h1>
 <!-- BOUTON EXPORT + SÉLECTION ANNÉE -->
<div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
  
  <!-- Bouton orange pour exporter les 3 graphiques -->
  <button id="exportAllCharts" class="btn-orange">
    Exporter les 3 graphiques
  </button>

  <!-- Sélecteur d'année -->
  <label for="yearFilter" style="margin:0;">Sélectionner une année :</label>
  <select id="yearFilter"></select>

</div>

  <!-- Graphiques existants -->
  <section style="display:flex; flex-wrap: wrap; gap:20px; justify-content:center; margin-top:20px;">
    <div style="flex:1; min-width:300px;">
      <canvas id="deptChart"></canvas>
    </div>
    <div style="flex:1; min-width:300px;">
      <canvas id="niveauChart"></canvas>
    </div>
    <div style="flex:1; min-width:300px;">
      <canvas id="genreChart"></canvas>
    </div>
  </section>

  <!-- Courbe annuelle -->
  <h2 style="margin-top:40px;">Évolution Annuelle des Effectifs</h2>
  <div style="width:100%; max-width:900px; margin:auto; text-align:center;">
    <canvas id="totalYearChart"></canvas>
    <button id="exportPNG">Exporter en PNG</button>
  </div>
</main>

<footer>© 2026 FSGF en chiffres</footer>

<script>
let statsData = [];

// Charger Excel
fetch('data/fsgf.xlsx?t=' + new Date().getTime())
  .then(res => res.arrayBuffer())
  .then(data => {
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets["Donnees"];
    statsData = XLSX.utils.sheet_to_json(sheet);

    const years = [...new Set(statsData.map(d => d.Année))].sort((a,b) => b-a);
    const yearFilter = document.getElementById("yearFilter");

    years.forEach(y => yearFilter.innerHTML += `<option value="${y}">${y}</option>`);

    updateCharts(years[0]);
    buildYearChart();
  });

// Changement année
document.getElementById("yearFilter").addEventListener("change", function() {
  updateCharts(this.value);
});

// Graphiques existants
function updateCharts(selectedYear){
  const currentYearData = statsData.filter(d => d.Année == selectedYear);

  // Département
  const deptTotals = {};
  currentYearData.forEach(d => { deptTotals[d.Département] = (deptTotals[d.Département]||0)+Number(d.Effectifs||0); });

  const deptCtx = document.getElementById("deptChart").getContext("2d");
  if(window.deptChartObj) window.deptChartObj.destroy();
  window.deptChartObj = new Chart(deptCtx, {
    type:'bar',
    data:{ labels:Object.keys(deptTotals), datasets:[{label:'Département', data:Object.values(deptTotals), backgroundColor:'#1f77b4'}]},
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });

  // Niveau
  const niveauTotals = {};
  currentYearData.forEach(d => { niveauTotals[d.Niveau] = (niveauTotals[d.Niveau]||0)+Number(d.Effectifs||0); });
  const niveauCtx = document.getElementById("niveauChart").getContext("2d");
  if(window.niveauChartObj) window.niveauChartObj.destroy();
  window.niveauChartObj = new Chart(niveauCtx,{ type:'pie', data:{labels:Object.keys(niveauTotals), datasets:[{data:Object.values(niveauTotals)}]}, options:{responsive:true} });

  // Genre
  const genreTotals = {M:0,F:0};
  currentYearData.forEach(d=>{ if(d.Genre=="M") genreTotals.M+=Number(d.Effectifs||0); if(d.Genre=="F") genreTotals.F+=Number(d.Effectifs||0); });
  const genreCtx = document.getElementById("genreChart").getContext("2d");
  if(window.genreChartObj) window.genreChartObj.destroy();
  window.genreChartObj = new Chart(genreCtx,{ type:'pie', data:{labels:["Masculin","Féminin"], datasets:[{data:[genreTotals.M, genreTotals.F]}]}, options:{responsive:true} });
}

// Courbe annuelle
function buildYearChart(){
  const totalsByYear = {};
  statsData.forEach(d => { totalsByYear[d.Année] = (totalsByYear[d.Année]||0)+Number(d.Effectifs||0); });

  const labels = Object.keys(totalsByYear).sort();
  const data = labels.map(y=>totalsByYear[y]);

  const ctx = document.getElementById("totalYearChart").getContext("2d");
  window.totalYearChartObj = new Chart(ctx,{
    type:'line',
    data:{ labels:labels, datasets:[{label:'Effectifs totaux', data:data, borderWidth:2, fill:false, tension:0.2}]},
    options:{
      responsive:true,
      animation:{ duration:1500, easing:'easeOutQuart' },
      plugins:{ legend:{ display:true, labels:{font:{size:14}} } },
      elements:{ line:{tension:0.35}, point:{radius:4, hoverRadius:7, hitRadius:10} },
      scales:{ y:{beginAtZero:true, ticks:{font:{size:12}}}, x:{ticks:{font:{size:12}}} }
    }
  });
}

// Export PNG
document.getElementById("exportPNG").addEventListener("click", function(){
  const link = document.createElement('a');
  link.href = document.getElementById("totalYearChart").toDataURL("image/png");
  link.download = "effectifs_annuels.png";
  link.click();
});
  document.getElementById("exportAllCharts").addEventListener("click", function(){
  const charts = ["deptChart", "niveauChart", "genreChart"];
  charts.forEach(id => {
    const canvas = document.getElementById(id);
    if(canvas){
      const link = document.createElement('a');
      link.download = id + ".png";
      link.href = canvas.toDataURL();
      link.click();
    }
  });
});
</script>
</body>
</html>
