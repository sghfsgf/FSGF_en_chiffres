<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>FSGF en chiffres - Vue globale</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header class="topbar">
  <div class="logo">FSGF en chiffres</div>
  <nav class="menu">
    <a href="index.html">Accueil</a>
    <a href="statistiques.html">Statistiques</a>
    <a href="comparaisons.html">Comparaisons</a>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<main>
  <h1>Vue globale - <span id="lastYearLabel"></span></h1>

  <!-- KPI -->
  <section class="card">
    <h2>Total Étudiants</h2>
    <div class="kpi" id="totalStudents">0</div>
    <div style="text-align:center;">
      Variation vs <span id="prevYearLabel"></span> :
      <strong id="variation"></strong>
    </div>
  </section>

  <!-- TABLEAU CROISÉ -->
  <section class="card">
    <h2>Effectifs <span id="tableYearLabel"></span></h2>
    <table id="pivotTable">
      <thead></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- CHARTS -->
  <section class="charts">
    <div class="chart-box">
      <canvas id="deptChart"></canvas>
      <button class="btn" onclick="exportPNG('deptChart')">Exporter PNG</button>
    </div>

    <div class="chart-box">
      <canvas id="niveauChart"></canvas>
      <button class="btn" onclick="exportPNG('niveauChart')">Exporter PNG</button>
    </div>

    <div class="chart-box">
      <canvas id="genreChart"></canvas>
      <button class="btn" onclick="exportPNG('genreChart')">Exporter PNG</button>
    </div>
  </section>

</main>

<footer>
  © 2026 FSGF en chiffres
</footer>

<script>
let statsData = [];
let deptChartObj, niveauChartObj, genreChartObj;

fetch('data/fsgf.xlsx')
  .then(res => res.arrayBuffer())
  .then(data => {
    const workbook = XLSX.read(data, { type:"array" });
    const sheet = workbook.Sheets["Donnees"];
    statsData = XLSX.utils.sheet_to_json(sheet);

    const years = statsData.map(d => Number(d.Année));
    const lastYear = Math.max(...years);
    const prevYear = lastYear - 1;

    document.getElementById("lastYearLabel").textContent = lastYear;
    document.getElementById("tableYearLabel").textContent = lastYear;
    document.getElementById("prevYearLabel").textContent = prevYear;

    const lastYearData = statsData.filter(d => Number(d.Année) === lastYear);
    const prevYearData = statsData.filter(d => Number(d.Année) === prevYear);

    buildDashboard(lastYearData, prevYearData);
  });

function buildDashboard(current, previous){
  const totalCurrent = current.reduce((s,d)=>s+Number(d.Effectifs),0);
  const totalPrevious = previous.reduce((s,d)=>s+Number(d.Effectifs),0);

  document.getElementById("totalStudents").textContent = totalCurrent;

  let variationText = "N/A";
  if(totalPrevious > 0){
    const varPct = ((totalCurrent-totalPrevious)/totalPrevious*100).toFixed(1);
    variationText = varPct + "%";
    document.getElementById("variation").className = varPct >= 0 ? "positive" : "negative";
  }
  document.getElementById("variation").textContent = variationText;

  buildPivotTable(current);
  buildCharts(current);
}

function buildPivotTable(data){
  const genres = [...new Set(data.map(d => d.Genre))].sort();
  const pivot = {};

  data.forEach(d => {
    const dept = d.Département;
    const niv = d.Niveau;
    const gen = d.Genre;
    const eff = Number(d.Effectifs);

    if(!pivot[dept]) pivot[dept] = {};
    if(!pivot[dept][niv]) pivot[dept][niv] = {};
    if(!pivot[dept][niv][gen]) pivot[dept][niv][gen] = 0;

    pivot[dept][niv][gen] += eff;
  });

  const thead = document.querySelector("#pivotTable thead");
  const tbody = document.querySelector("#pivotTable tbody");

  let headerRow = "<tr><th>Département</th><th>Niveau</th>";
  genres.forEach(g => headerRow += `<th>${g}</th>`);
  headerRow += "<th>Total</th></tr>";
  thead.innerHTML = headerRow;
  tbody.innerHTML = "";

  for(const dept in pivot){
    for(const niv in pivot[dept]){
      let row = "<tr>";
      row += `<td><strong>${dept}</strong></td>`;
      row += `<td>${niv}</td>`;

      let total = 0;
      genres.forEach(g => {
        const val = pivot[dept][niv][g] || 0;
        row += `<td>${val}</td>`;
        total += val;
      });
      row += `<td><strong>${total}</strong></td></tr>`;
      tbody.innerHTML += row;
    }
  }
}

function buildCharts(data){
  const deptTotals = {};
  data.forEach(d => deptTotals[d.Département]=(deptTotals[d.Département]||0)+Number(d.Effectifs));

  if(deptChartObj) deptChartObj.destroy();
  deptChartObj = new Chart(document.getElementById("deptChart"),{
    type:'bar',
    data:{ labels:Object.keys(deptTotals), datasets:[{label:'Départements', data:Object.values(deptTotals), backgroundColor:'#ff7f0e'}]},
    options:{ responsive:true, plugins:{legend:{display:false}} }
  });

  const niveauTotals = {};
  data.forEach(d => niveauTotals[d.Niveau]=(niveauTotals[d.Niveau]||0)+Number(d.Effectifs));

  if(niveauChartObj) niveauChartObj.destroy();
  niveauChartObj = new Chart(document.getElementById("niveauChart"),{
    type:'pie',
    data:{ labels:Object.keys(niveauTotals), datasets:[{data:Object.values(niveauTotals)}] },
    options:{ responsive:true }
  });

  const genreTotals = {M:0,F:0};
  data.forEach(d=>{ if(d.Genre==='M') genreTotals.M+=Number(d.Effectifs); else genreTotals.F+=Number(d.Effectifs); });

  if(genreChartObj) genreChartObj.destroy();
  genreChartObj = new Chart(document.getElementById("genreChart"),{
    type:'pie',
    data:{ labels:['Masculin','Féminin'], datasets:[{data:[genreTotals.M, genreTotals.F]}] },
    options:{ responsive:true }
  });
}

function exportPNG(id){
  const canvas = document.getElementById(id);
  const link = document.createElement('a');
  link.download = id + ".png";
  link.href = canvas.toDataURL();
  link.click();
}
</script>

</body>
</html>
